---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by WGPavell.
--- DateTime: 24.03.2025 18:58
---

FRAMES_TO_HIDE = {'ConsoleBottomBarOverlay', 'CommandBarFrame'}
for i = 0, 11 do
    table.insert(FRAMES_TO_HIDE, "CommandButton_" .. i)
end

FULLSCREEN_CANVAS_SIZE_REFRESH_PERIOD = 0.02
--- @type SimpleEmptyFrame
fullscreenWrapperFrame = nil
--- @type SimpleEmptyFrame
fullscreenCanvasFrame = nil
fullscreenCanvasTimer = CreateTimer()

function GetScreenFrameWidth()
    return BlzGetLocalClientWidth() / BlzGetLocalClientHeight() * 0.6
end

function UpdateFullscreenCanvasSize()
    BlzFrameSetSize(fullscreenCanvasFrame.handle, GetScreenFrameWidth(), 0.6)
end

TEXT_BASE_SCALE_HEIGHT = 0.0092

--- @type TextureFrame
leftSideIconFrame = nil
--- @type SimpleTextFrame
leftSideTextFrame = nil
--- @type SimpleTextFrame
leftSideStatisticsTextFrame = nil
--- @type TextureFrame
rightSideIconFrame = nil
--- @type SimpleTextFrame
rightSideTextFrame = nil
--- @type SimpleTextFrame
rightSideStatisticsTextFrame = nil


SIDE_FRAME_LEFT = 1
SIDE_FRAME_RIGHT = 2

upgradeFrames = {
    [SIDE_FRAME_LEFT] = {
        visible_total = 0,
        frames = {}
    },
    [SIDE_FRAME_RIGHT] = {
        visible_total = 0,
        frames = {}
    }
}


--- @type SimpleEmptyFrame
battleInfoWrapperFrame = nil
--- @type SimpleTextFrame
battleInfoLeftSideTitleFrame = nil
--- @type SimpleTextFrame
battleInfoRightSideTitleFrame = nil
--- @type SimpleTextFrame
battleInfoVersusLabelFrame = nil
--- @type TemplateBackdropFrame
battleWinnerBackdropFrame = nil
--- @type SimpleTextFrame
battleWinnerTextFrame = nil


TOTAL_UNIT_STATISTICS_BACKDROP_PADDING_X = 0.05
TOTAL_UNIT_STATISTICS_BACKDROP_PADDING_Y = 0.05
TOTAL_UNIT_STATISTICS_BACKDROP_HEIGHT = 0.4
--- @type TemplateBackdropFrame
totalUnitStatisticsBackdropFrame = nil
--- @type SimpleTextFrame
totalUnitStatisticsHeaderFrame = nil

TOTAL_UNIT_STATISTICS_WRAPPER_PADDING_X = 0.025
TOTAL_UNIT_STATISTICS_WRAPPER_PADDING_Y = 0.025
--- @type SimpleEmptyFrame
totalUnitStatisticsWrapperFrame = nil

TOTAL_UNIT_STATISTICS_ICON_FRAME_WIDTH = 0.16
TOTAL_UNIT_STATISTICS_ICON_FRAME_HEIGHT = 0.036
TOTAL_UNIT_STATISTICS_ICON_SPACE_X_MIN = 0.01
TOTAL_UNIT_STATISTICS_ICON_SPACE_Y_MIN = 0.0075
TOTAL_UNIT_STATISTICS_APPEAR_DELAY = 0.2
TOTAL_UNIT_STATISTICS_FADING_IN_DURATION = 1

totalUnitStatisticsBattleListFrames = {}


TOTAL_BATTLES_STATISTICS_BACKDROP_PADDING_X = 0.015
TOTAL_BATTLES_STATISTICS_BACKDROP_PADDING_Y = 0.015
--- @type TemplateBackdropFrame
totalBattlesStatisticsBackdropFrame = nil

TOTAL_BATTLES_STATISTICS_WRAPPER_PADDING_X = 0.025
TOTAL_BATTLES_STATISTICS_WRAPPER_PADDING_Y = 0.025
--- @type SimpleEmptyFrame
totalBattlesStatisticsWrapperFrame = nil

--- @type SimpleEmptyFrame
totalBattlesStatisticsRacesWrapperFrame = nil
TOTAL_BATTLES_STATISTICS_RACE_WRAPPER_SPACE_Y = 0.01
TOTAL_BATTLES_STATISTICS_RACE_TEXT_SCALE = 2.5
TOTAL_BATTLES_STATISTICS_RACE_TEXT_HEIGHT = TEXT_BASE_SCALE_HEIGHT * TOTAL_BATTLES_STATISTICS_RACE_TEXT_SCALE
TOTAL_BATTLES_STATISTICS_RACE_TEXT_MARGIN_BOTTOM = 0.002 * TOTAL_BATTLES_STATISTICS_RACE_TEXT_SCALE

TOTAL_BATTLES_STATISTICS_ICON_FRAME_WIDTH = 0.12
TOTAL_BATTLES_STATISTICS_ICON_FRAME_HEIGHT = 0.0265
TOTAL_BATTLES_STATISTICS_ICON_SPACE_X_MIN = 0.006
TOTAL_BATTLES_STATISTICS_ICON_SPACE_Y_MIN = 0.005
TOTAL_BATTLES_STATISTICS_ICON_TEXT_BASE_SCALE = 1.8
TOTAL_BATTLES_STATISTICS_APPEAR_DELAY = 0.1
TOTAL_BATTLES_STATISTICS_FADING_IN_DURATION = 1

totalBattlesStatisticsBattleListFrames = {}

--- @type SimpleEmptyFrame
totalBattlesStatisticsTopsWrapperFrame = nil
TOTAL_BATTLES_STATISTICS_TOPS_COLUMN_SPACE_X = 0.04
TOTAL_BATTLES_STATISTICS_TOPS_COLUMN_TITLE_TEXT_SCALE = 3
TOTAL_BATTLES_STATISTICS_TOPS_COLUMN_TITLE_HEIGHT = TEXT_BASE_SCALE_HEIGHT * TOTAL_BATTLES_STATISTICS_TOPS_COLUMN_TITLE_TEXT_SCALE
TOTAL_BATTLES_STATISTICS_TOPS_COLUMN_TITLE_MARGIN_BOTTOM = 0.002 * TOTAL_BATTLES_STATISTICS_TOPS_COLUMN_TITLE_TEXT_SCALE
TOTAL_BATTLES_STATISTICS_TOPS_COLUMN_SUBTITLE_TEXT_SCALE = 2.5
TOTAL_BATTLES_STATISTICS_TOPS_COLUMN_SUBTITLE_HEIGHT = TEXT_BASE_SCALE_HEIGHT * TOTAL_BATTLES_STATISTICS_TOPS_COLUMN_SUBTITLE_TEXT_SCALE
TOTAL_BATTLES_STATISTICS_TOPS_COLUMN_SUBTITLE_MARGIN_BOTTOM = 0.0014 * TOTAL_BATTLES_STATISTICS_TOPS_COLUMN_SUBTITLE_TEXT_SCALE
TOTAL_BATTLES_STATISTICS_TOPS_INNER_COLUMN_SPACE_X = 0.02
TOTAL_BATTLES_STATISTICS_TOPS_MAX_ROWS = 5

TOTAL_BATTLES_STATISTICS_TOPS_ICON_FRAME_WIDTH = 0.12
TOTAL_BATTLES_STATISTICS_TOPS_ICON_FRAME_HEIGHT = 0.027
TOTAL_BATTLES_STATISTICS_TOPS_ICON_SPACE_Y_MIN = 0.0075
TOTAL_BATTLES_STATISTICS_TOPS_ICON_TEXT_BASE_SCALE = 1.8
TOTAL_BATTLES_STATISTICS_TOPS_APPEAR_DELAY = 0.1
TOTAL_BATTLES_STATISTICS_TOPS_FADING_IN_DURATION = 1

totalBattlesStatisticsTopsMainColumns = {"Войска", "Герои"}
totalBattlesStatisticsTopsSubColumns = {"|cff00ff00Лучшие|r", "|cffff0000Худшие|r"}
totalBattlesStatisticsTopsContainers = {}

OnInit.map(function()
    -- Hide all unnecessary frames
    BlzHideOriginFrames(true)
    local framesToHide = {}
    for _, frameName in ipairs(FRAMES_TO_HIDE) do
        table.insert(framesToHide, BlzGetFrameByName(frameName, 0))
    end
    for _, frame in ipairs(framesToHide) do
        BlzFrameSetVisible(frame, false)
    end

    -- Creating fullscreen frame
    local mainFrame = BlzGetFrameByName("ConsoleUIBackdrop", 0)
    fullscreenWrapperFrame = SimpleEmptyFrame:new("FullscreenWrapper", mainFrame)
    fullscreenCanvasFrame = SimpleEmptyFrame:new("FullscreenCanvas", fullscreenWrapperFrame.handle)
    BlzFrameSetVisible(fullscreenCanvasFrame.handle, false)
    UpdateFullscreenCanvasSize()
    TimerStart(fullscreenCanvasTimer, FULLSCREEN_CANVAS_SIZE_REFRESH_PERIOD, true, UpdateFullscreenCanvasSize)
    BlzFrameSetAbsPoint(fullscreenCanvasFrame.handle, FRAMEPOINT_BOTTOM, 0.4, 0)

    leftSideIconFrame = TextureFrame:new("LeftSideIcon", "", fullscreenWrapperFrame.handle)
    leftSideIconFrame.cover:setSize(0.045, 0.045):setRelativePoint(FRAMEPOINT_TOPLEFT, fullscreenCanvasFrame.handle, FRAMEPOINT_TOPLEFT, 0.03, -0.03):setVisible(false)
    leftSideTextFrame = SimpleTextFrame:new("LeftSideText", "0", 2, fullscreenWrapperFrame.handle)
    leftSideTextFrame:setRelativePoint(FRAMEPOINT_LEFT, leftSideIconFrame.cover.handle, FRAMEPOINT_RIGHT, 0.003, 0):setVisible(false)
    leftSideStatisticsTextFrame = SimpleTextFrame:new("LeftSideStatisticsText", "Всего убито: 0|nВсего умерло: 0", 1.25, fullscreenWrapperFrame.handle)
    leftSideStatisticsTextFrame:setRelativePoint(FRAMEPOINT_LEFT, leftSideTextFrame.handle, FRAMEPOINT_RIGHT, 0.01, 0):setRelativePoint(FRAMEPOINT_TOP, leftSideIconFrame.cover.handle, FRAMEPOINT_TOP, 0, 0):setAlignment(TEXT_JUSTIFY_TOP, TEXT_JUSTIFY_LEFT):setVisible(false)

    rightSideIconFrame = TextureFrame:new("RightSideIcon", "", fullscreenWrapperFrame.handle)
    rightSideIconFrame.cover:setSize(0.045, 0.045):setRelativePoint(FRAMEPOINT_TOPRIGHT, fullscreenCanvasFrame.handle, FRAMEPOINT_TOPRIGHT, -0.03, -0.03):setVisible(false)
    rightSideTextFrame = SimpleTextFrame:new("RightSideText", "0", 2, fullscreenWrapperFrame.handle)
    rightSideTextFrame:setRelativePoint(FRAMEPOINT_RIGHT, rightSideIconFrame.cover.handle, FRAMEPOINT_LEFT, -0.003, 0):setVisible(false)
    rightSideStatisticsTextFrame = SimpleTextFrame:new("RightSideStatisticsText", "Всего убито: 0|nВсего умерло: 0", 1.25, fullscreenWrapperFrame.handle)
    rightSideStatisticsTextFrame:setRelativePoint(FRAMEPOINT_RIGHT, rightSideTextFrame.handle, FRAMEPOINT_LEFT, -0.01, 0):setRelativePoint(FRAMEPOINT_TOP, rightSideIconFrame.cover.handle, FRAMEPOINT_TOP, 0, 0):setAlignment(TEXT_JUSTIFY_TOP, TEXT_JUSTIFY_RIGHT):setVisible(false)

    battleInfoWrapperFrame = SimpleTypeFrame:new("BattleInfoWrapper", "SPRITE", fullscreenWrapperFrame.handle, "", 0)
    battleInfoWrapperFrame:setSize(0.3, 0):setRelativePoint(FRAMEPOINT_TOP, fullscreenCanvasFrame.handle, FRAMEPOINT_TOP, 0, 0):setRelativePoint(FRAMEPOINT_BOTTOM, fullscreenCanvasFrame.handle, FRAMEPOINT_BOTTOM, 0, 0)
    battleInfoLeftSideTitleFrame = SimpleTextFrame:new("BattleInfoLeftSideTitle", "", 3, battleInfoWrapperFrame.handle)
    battleInfoLeftSideTitleFrame:setRelativePoint(FRAMEPOINT_TOP, battleInfoWrapperFrame.handle, FRAMEPOINT_TOP, 0, -0.006)
    battleInfoVersusLabelFrame = SimpleTextFrame:new("BattleInfoVersusLabel", "против", 2.6, battleInfoWrapperFrame.handle)
    battleInfoVersusLabelFrame:setRelativePoint(FRAMEPOINT_TOP, battleInfoLeftSideTitleFrame.handle, FRAMEPOINT_BOTTOM, 0, -0.004)
    battleInfoRightSideTitleFrame = SimpleTextFrame:new("BattleInfoRightSideTitle", "", 3, battleInfoWrapperFrame.handle)
    battleInfoRightSideTitleFrame:setRelativePoint(FRAMEPOINT_TOP, battleInfoVersusLabelFrame.handle, FRAMEPOINT_BOTTOM, 0, -0.004)
    battleInfoWrapperFrame:setVisible(false)

    battleWinnerBackdropFrame = TemplateBackdropFrame:new("BattleWinnerBackdrop", "QuestButtonBaseTemplate", fullscreenWrapperFrame.handle)
    battleWinnerTextFrame = SimpleTextFrame:new("BattleWinnerText", "", 4, battleWinnerBackdropFrame.cover.handle)
    battleWinnerTextFrame:setAlignment(TEXT_JUSTIFY_MIDDLE, TEXT_JUSTIFY_CENTER)
    battleWinnerBackdropFrame.cover:setAbsPoint(FRAMEPOINT_CENTER, 0.4, 0.3):setSize(0.4, 0):setVisible(false)
    battleWinnerTextFrame
        :setRelativePoint(FRAMEPOINT_TOP, battleWinnerBackdropFrame.cover.handle, FRAMEPOINT_TOP, 0, -0.1)
        :setRelativePoint(FRAMEPOINT_BOTTOM, battleWinnerBackdropFrame.cover.handle, FRAMEPOINT_BOTTOM, 0, 0.1)
        :setRelativePoint(FRAMEPOINT_LEFT, battleWinnerBackdropFrame.cover.handle, FRAMEPOINT_LEFT, 0.005, 0)
        :setRelativePoint(FRAMEPOINT_RIGHT, battleWinnerBackdropFrame.cover.handle, FRAMEPOINT_RIGHT, -0.005, 0)
        :setVisible(false)

    totalUnitStatisticsBackdropFrame = TemplateBackdropFrame:new("TotalUnitStatisticsBackdrop", "EscMenuBackdrop", fullscreenWrapperFrame.handle)
    totalUnitStatisticsBackdropFrame.cover
        :setRelativePoint(FRAMEPOINT_BOTTOMLEFT, fullscreenCanvasFrame.handle, FRAMEPOINT_BOTTOMLEFT, TOTAL_UNIT_STATISTICS_BACKDROP_PADDING_X, TOTAL_UNIT_STATISTICS_BACKDROP_PADDING_Y)
        :setRelativePoint(FRAMEPOINT_BOTTOMRIGHT, fullscreenCanvasFrame.handle, FRAMEPOINT_BOTTOMRIGHT, -TOTAL_UNIT_STATISTICS_BACKDROP_PADDING_X, TOTAL_UNIT_STATISTICS_BACKDROP_PADDING_Y)
        :setSize(0, TOTAL_UNIT_STATISTICS_BACKDROP_HEIGHT)
        :setVisible(false)
    totalUnitStatisticsHeaderFrame = SimpleTextFrame:new("TotalUnitStatisticsHeader", "РЕЗУЛЬТАТЫ - ", 3, fullscreenWrapperFrame.handle)
    totalUnitStatisticsHeaderFrame
        :setRelativePoint(FRAMEPOINT_BOTTOM, totalUnitStatisticsBackdropFrame.cover.handle, FRAMEPOINT_TOP, 0, 0.01)
        :setColor(255, 204, 0)
        :setVisible(false)
    totalUnitStatisticsWrapperFrame = SimpleEmptyFrame:new("TotalUnitStatisticsWrapper", totalUnitStatisticsBackdropFrame.cover.handle)
    totalUnitStatisticsWrapperFrame
        :setRelativePoint(FRAMEPOINT_TOPLEFT, totalUnitStatisticsBackdropFrame.cover.handle, FRAMEPOINT_TOPLEFT, TOTAL_UNIT_STATISTICS_WRAPPER_PADDING_X, -TOTAL_UNIT_STATISTICS_WRAPPER_PADDING_Y)
        :setRelativePoint(FRAMEPOINT_TOPRIGHT, totalUnitStatisticsBackdropFrame.cover.handle, FRAMEPOINT_TOPRIGHT, -TOTAL_UNIT_STATISTICS_WRAPPER_PADDING_X, -TOTAL_UNIT_STATISTICS_WRAPPER_PADDING_Y)
        :setRelativePoint(FRAMEPOINT_BOTTOM, totalUnitStatisticsBackdropFrame.cover.handle, FRAMEPOINT_BOTTOM, 0, TOTAL_UNIT_STATISTICS_WRAPPER_PADDING_Y)

    totalBattlesStatisticsBackdropFrame = TemplateBackdropFrame:new("TotalBattlesStatisticsBackdrop", "EscMenuBackdrop", fullscreenWrapperFrame.handle)
    totalBattlesStatisticsBackdropFrame.cover
        :setRelativePoint(FRAMEPOINT_BOTTOMLEFT, fullscreenCanvasFrame.handle, FRAMEPOINT_BOTTOMLEFT, TOTAL_BATTLES_STATISTICS_BACKDROP_PADDING_X, TOTAL_BATTLES_STATISTICS_BACKDROP_PADDING_Y)
        :setRelativePoint(FRAMEPOINT_BOTTOMRIGHT, fullscreenCanvasFrame.handle, FRAMEPOINT_BOTTOMRIGHT, -TOTAL_BATTLES_STATISTICS_BACKDROP_PADDING_X, TOTAL_BATTLES_STATISTICS_BACKDROP_PADDING_Y)
        :setRelativePoint(FRAMEPOINT_TOPLEFT, fullscreenCanvasFrame.handle, FRAMEPOINT_TOPLEFT, TOTAL_BATTLES_STATISTICS_BACKDROP_PADDING_X, -TOTAL_BATTLES_STATISTICS_BACKDROP_PADDING_Y)
        :setRelativePoint(FRAMEPOINT_TOPRIGHT, fullscreenCanvasFrame.handle, FRAMEPOINT_TOPRIGHT, -TOTAL_BATTLES_STATISTICS_BACKDROP_PADDING_X, -TOTAL_BATTLES_STATISTICS_BACKDROP_PADDING_Y)
        :setVisible(false)
    totalBattlesStatisticsWrapperFrame = SimpleEmptyFrame:new("TotalBattlesStatisticsWrapper", totalBattlesStatisticsBackdropFrame.cover.handle)
    totalBattlesStatisticsWrapperFrame
        :setRelativePoint(FRAMEPOINT_TOPLEFT, totalBattlesStatisticsBackdropFrame.cover.handle, FRAMEPOINT_TOPLEFT, TOTAL_BATTLES_STATISTICS_WRAPPER_PADDING_X, -TOTAL_BATTLES_STATISTICS_WRAPPER_PADDING_Y)
        :setRelativePoint(FRAMEPOINT_TOPRIGHT, totalBattlesStatisticsBackdropFrame.cover.handle, FRAMEPOINT_TOPRIGHT, -TOTAL_BATTLES_STATISTICS_WRAPPER_PADDING_X, -TOTAL_BATTLES_STATISTICS_WRAPPER_PADDING_Y)
        :setRelativePoint(FRAMEPOINT_BOTTOM, totalBattlesStatisticsBackdropFrame.cover.handle, FRAMEPOINT_BOTTOM, 0, TOTAL_BATTLES_STATISTICS_WRAPPER_PADDING_Y)

    totalBattlesStatisticsRacesWrapperFrame = SimpleEmptyFrame:new("TotalBattlesStatisticsRacesWrapper", totalBattlesStatisticsWrapperFrame.handle)
    totalBattlesStatisticsRacesWrapperFrame:setAllPoints(totalBattlesStatisticsWrapperFrame.handle):setVisible(false)


    totalBattlesStatisticsTopsWrapperFrame = SimpleEmptyFrame:new("TotalBattlesStatisticsTopsWrapper", totalBattlesStatisticsWrapperFrame.handle)
    totalBattlesStatisticsTopsWrapperFrame:setAllPoints(totalBattlesStatisticsWrapperFrame.handle):setVisible(false)
    totalBattlesStatisticsTopsSubColumns = { "|cff00ff00Лучшие|r", "|cffff0000Худшие|r"}
    local containerWidth = (GetScreenFrameWidth() - TOTAL_BATTLES_STATISTICS_BACKDROP_PADDING_X * 2 - TOTAL_BATTLES_STATISTICS_WRAPPER_PADDING_X * 2 - TOTAL_BATTLES_STATISTICS_TOPS_COLUMN_SPACE_X * (#totalBattlesStatisticsTopsMainColumns - 1)) / #totalBattlesStatisticsTopsMainColumns
    local containerHeight = 0.6 - TOTAL_BATTLES_STATISTICS_BACKDROP_PADDING_Y * 2 - TOTAL_BATTLES_STATISTICS_WRAPPER_PADDING_Y * 2
    local subcontainerWidth = (containerWidth - TOTAL_BATTLES_STATISTICS_TOPS_INNER_COLUMN_SPACE_X * (#totalBattlesStatisticsTopsSubColumns - 1)) / #totalBattlesStatisticsTopsSubColumns
    local subcontainerHeight = containerHeight - TOTAL_BATTLES_STATISTICS_TOPS_COLUMN_TITLE_HEIGHT - TOTAL_BATTLES_STATISTICS_TOPS_COLUMN_TITLE_MARGIN_BOTTOM
    local iconFrameHeight = subcontainerWidth * 0.22
    local unitListContainerHeight = subcontainerHeight - TOTAL_BATTLES_STATISTICS_TOPS_COLUMN_SUBTITLE_HEIGHT - TOTAL_BATTLES_STATISTICS_TOPS_COLUMN_SUBTITLE_MARGIN_BOTTOM
    local iconFrameSpaceBetween = (unitListContainerHeight - (iconFrameHeight * TOTAL_BATTLES_STATISTICS_TOPS_MAX_ROWS)) / (TOTAL_BATTLES_STATISTICS_TOPS_MAX_ROWS - 1)

    local topContainers = {}
    for i, title in ipairs(totalBattlesStatisticsTopsMainColumns) do
        local containerFrame = SimpleEmptyFrame:new("TotalBattlesStatisticsTopContainer", totalBattlesStatisticsTopsWrapperFrame.handle, i)
        local titleFrame = SimpleTextFrame:new("TotalBattlesStatisticsTopTitle", "|cffffcc00" .. title .. "|r", TOTAL_BATTLES_STATISTICS_TOPS_COLUMN_TITLE_TEXT_SCALE, containerFrame.handle, i)
        containerFrame:setSize(containerWidth, 0)
        titleFrame
            :setRelativePoint(FRAMEPOINT_TOPLEFT, containerFrame.handle, FRAMEPOINT_TOPLEFT, 0, 0)
            :setRelativePoint(FRAMEPOINT_TOPRIGHT, containerFrame.handle, FRAMEPOINT_TOPRIGHT, 0, 0)
            :setSize(0, TEXT_BASE_SCALE_HEIGHT)
            :setAlignment(TEXT_JUSTIFY_MIDDLE, TEXT_JUSTIFY_CENTER)
        if i == 1 then
            containerFrame
                :setRelativePoint(FRAMEPOINT_TOPLEFT, totalBattlesStatisticsTopsWrapperFrame.handle, FRAMEPOINT_TOPLEFT, 0, 0)
                :setRelativePoint(FRAMEPOINT_BOTTOMLEFT, totalBattlesStatisticsTopsWrapperFrame.handle, FRAMEPOINT_BOTTOMLEFT, 0, 0)
        else
            containerFrame
                :setRelativePoint(FRAMEPOINT_TOPLEFT, topContainers[i - 1].container.handle, FRAMEPOINT_TOPRIGHT, TOTAL_BATTLES_STATISTICS_TOPS_COLUMN_SPACE_X, 0)
                :setRelativePoint(FRAMEPOINT_BOTTOMLEFT, topContainers[i - 1].container.handle, FRAMEPOINT_BOTTOMRIGHT, TOTAL_BATTLES_STATISTICS_TOPS_COLUMN_SPACE_X, 0)
        end
        if i == #totalBattlesStatisticsTopsMainColumns then
            containerFrame
                :setRelativePoint(FRAMEPOINT_TOPRIGHT, totalBattlesStatisticsWrapperFrame.handle, FRAMEPOINT_TOPRIGHT, 0, 0)
                :setRelativePoint(FRAMEPOINT_BOTTOMRIGHT, totalBattlesStatisticsWrapperFrame.handle, FRAMEPOINT_BOTTOMRIGHT, 0, 0)
        end
        local subContainers = {}
        for j, subtitle in ipairs(totalBattlesStatisticsTopsSubColumns) do
            local subcontainerFrame = SimpleEmptyFrame:new("TotalBattlesStatisticsTopSubcontainer", containerFrame.handle, j)
            local subtitleFrame = SimpleTextFrame:new("TotalBattlesStatisticsTopSubtitle", "|cffffcc00" .. subtitle .. "|r", TOTAL_BATTLES_STATISTICS_TOPS_COLUMN_SUBTITLE_TEXT_SCALE, subcontainerFrame.handle, j)
            local unitListContainerFrame = SimpleEmptyFrame:new("TotalBattlesStatisticsTopUnitListContainer", subcontainerFrame.handle, j)
            subcontainerFrame:setSize(subcontainerWidth, 0)
            subtitleFrame
                :setRelativePoint(FRAMEPOINT_TOPLEFT, subcontainerFrame.handle, FRAMEPOINT_TOPLEFT, 0, 0)
                :setRelativePoint(FRAMEPOINT_TOPRIGHT, subcontainerFrame.handle, FRAMEPOINT_TOPRIGHT, 0, 0)
                :setSize(0, TEXT_BASE_SCALE_HEIGHT)
                :setAlignment(TEXT_JUSTIFY_MIDDLE, TEXT_JUSTIFY_CENTER)
            unitListContainerFrame
                :setRelativePoint(FRAMEPOINT_TOPLEFT, subtitleFrame.handle, FRAMEPOINT_BOTTOMLEFT, 0, -TOTAL_BATTLES_STATISTICS_TOPS_COLUMN_SUBTITLE_MARGIN_BOTTOM)
                :setRelativePoint(FRAMEPOINT_TOPRIGHT, subtitleFrame.handle, FRAMEPOINT_TOPRIGHT, 0, 0)
                :setRelativePoint(FRAMEPOINT_BOTTOMLEFT, subcontainerFrame.handle, FRAMEPOINT_BOTTOMLEFT, 0, 0)
                :setRelativePoint(FRAMEPOINT_BOTTOMRIGHT, subcontainerFrame.handle, FRAMEPOINT_BOTTOMRIGHT, 0, 0)
            if j == 1 then
                subcontainerFrame
                    :setRelativePoint(FRAMEPOINT_TOPLEFT, titleFrame.handle, FRAMEPOINT_BOTTOMLEFT, 0, -TOTAL_BATTLES_STATISTICS_TOPS_COLUMN_TITLE_MARGIN_BOTTOM)
                    :setRelativePoint(FRAMEPOINT_BOTTOMLEFT, containerFrame.handle, FRAMEPOINT_BOTTOMLEFT, 0, 0)
            else
                subcontainerFrame
                    :setRelativePoint(FRAMEPOINT_TOPLEFT, subContainers[j - 1].container.handle, FRAMEPOINT_TOPRIGHT, TOTAL_BATTLES_STATISTICS_TOPS_INNER_COLUMN_SPACE_X, 0)
                    :setRelativePoint(FRAMEPOINT_BOTTOMLEFT, subContainers[j - 1].container.handle, FRAMEPOINT_BOTTOMRIGHT, TOTAL_BATTLES_STATISTICS_TOPS_INNER_COLUMN_SPACE_X, 0)
            end
            if j == #totalBattlesStatisticsTopsSubColumns then
                subcontainerFrame
                    :setRelativePoint(FRAMEPOINT_TOPRIGHT, titleFrame.handle, FRAMEPOINT_BOTTOMRIGHT, 0, -TOTAL_BATTLES_STATISTICS_TOPS_COLUMN_TITLE_MARGIN_BOTTOM)
                    :setRelativePoint(FRAMEPOINT_BOTTOMRIGHT, containerFrame.handle, FRAMEPOINT_BOTTOMRIGHT, 0, 0)
            end
            local unitListContainers = {}
            for k = 1, TOTAL_BATTLES_STATISTICS_TOPS_MAX_ROWS do
                local wrapperFrame = SimpleEmptyFrame:new("TotalBattlesStatisticsTopUnitListContainerEntryWrapper", unitListContainerFrame.handle, k)
                local iconFrame = TextureFrame:new("TotalBattlesStatisticsTopUnitListContainerEntryIcon", "", wrapperFrame.handle, k)
                local textFrame = SimpleTextFrame:new("TotalBattlesStatisticsTopUnitListContainerEntryText", "", TOTAL_BATTLES_STATISTICS_TOPS_ICON_TEXT_BASE_SCALE * (iconFrameHeight / 0.06), wrapperFrame.handle, k)
                wrapperFrame
                    :setSize(0, iconFrameHeight)
                iconFrame.cover
                     :setSize(iconFrameHeight, iconFrameHeight)
                     :setRelativePoint(FRAMEPOINT_TOPLEFT, wrapperFrame.handle, FRAMEPOINT_TOPLEFT, 0, 0)
                     :setRelativePoint(FRAMEPOINT_BOTTOMLEFT, wrapperFrame.handle, FRAMEPOINT_BOTTOMLEFT, 0, 0)
                textFrame
                    :setRelativePoint(FRAMEPOINT_TOPLEFT, iconFrame.cover.handle, FRAMEPOINT_TOPRIGHT, 0.0022 * TOTAL_BATTLES_STATISTICS_TOPS_ICON_TEXT_BASE_SCALE * (iconFrameHeight / 0.06), 0)
                    :setRelativePoint(FRAMEPOINT_BOTTOMLEFT, iconFrame.cover.handle, FRAMEPOINT_BOTTOMLEFT, 0.0022 * TOTAL_BATTLES_STATISTICS_TOPS_ICON_TEXT_BASE_SCALE * (iconFrameHeight / 0.06), 0)
                    :setRelativePoint(FRAMEPOINT_TOPRIGHT, wrapperFrame.handle, FRAMEPOINT_TOPRIGHT, 0, 0)
                    :setRelativePoint(FRAMEPOINT_BOTTOMRIGHT, wrapperFrame.handle, FRAMEPOINT_BOTTOMRIGHT, 0, 0)
                    :setAlignment(TEXT_JUSTIFY_MIDDLE, TEXT_JUSTIFY_CENTER)
                textFrame:setText("Чудесный дракончик\nПобед: 30/60 (50.00%)")
                if k == 1 then
                    wrapperFrame
                        :setRelativePoint(FRAMEPOINT_TOPLEFT, unitListContainerFrame.handle, FRAMEPOINT_TOPLEFT, 0, -TOTAL_BATTLES_STATISTICS_TOPS_COLUMN_SUBTITLE_MARGIN_BOTTOM)
                        :setRelativePoint(FRAMEPOINT_TOPRIGHT, unitListContainerFrame.handle, FRAMEPOINT_TOPRIGHT, 0, -TOTAL_BATTLES_STATISTICS_TOPS_COLUMN_SUBTITLE_MARGIN_BOTTOM)
                else
                    wrapperFrame
                        :setRelativePoint(FRAMEPOINT_TOPLEFT, unitListContainers[k - 1].wrapper.handle, FRAMEPOINT_BOTTOMLEFT, 0, -iconFrameSpaceBetween)
                        :setRelativePoint(FRAMEPOINT_TOPRIGHT, unitListContainers[k - 1].wrapper.handle, FRAMEPOINT_BOTTOMRIGHT, 0, -iconFrameSpaceBetween)
                end
                table.insert(unitListContainers, {
                    wrapper = wrapperFrame,
                    icon = iconFrame,
                    text = textFrame
                })
            end
            table.insert(subContainers, {
                container = subcontainerFrame,
                subContainers = unitListContainers
            })
        end
        table.insert(topContainers, {
            container = containerFrame,
            subContainers = subContainers
        })
    end
    totalBattlesStatisticsTopsContainers = topContainers

    BlzFrameClearAllPoints(mainFrame)
end)

function ClearUpgradeFrames()
    for _, sideUpgradeFrames in ipairs(upgradeFrames) do
        ---@param upgradeFrame SimpleTypeFrame
        for _, upgradeFrame in ipairs(sideUpgradeFrames.frames) do
            upgradeFrame:setVisible(false)
        end
        sideUpgradeFrames.visible_total = 0
    end
end

function AppendUpgradeFrame(side)
    local frameIndex = upgradeFrames[side].visible_total + 1
    ---@type UpgradeDataFrame
    local upgradeFrame = upgradeFrames[side].frames[frameIndex]
    if (upgradeFrame == nil) then
        upgradeFrame = UpgradeDataFrame:new("UpgradeFrameContainer", "", "0", 1.25, side == SIDE_FRAME_LEFT and UPGRADE_DATA_FRAME_TEXT_ALIGNMENT_RIGHT or UPGRADE_DATA_FRAME_TEXT_ALIGNMENT_LEFT, fullscreenWrapperFrame.handle, frameIndex - 1)
        upgradeFrame:setSize(0.034, 0.0225)
        upgradeFrames[side].frames[frameIndex] = upgradeFrame
        if frameIndex == 1 then
            upgradeFrame.cover:setRelativePoint(side == SIDE_FRAME_LEFT and FRAMEPOINT_TOPLEFT or FRAMEPOINT_TOPRIGHT, side == SIDE_FRAME_LEFT and leftSideIconFrame.cover.handle or rightSideIconFrame.cover.handle, side == SIDE_FRAME_LEFT and FRAMEPOINT_BOTTOMLEFT or FRAMEPOINT_BOTTOMRIGHT, 0, -0.015)
        elseif (frameIndex - 1) % 4 == 0 then
            upgradeFrame.cover:setRelativePoint(side == SIDE_FRAME_LEFT and FRAMEPOINT_TOPLEFT or FRAMEPOINT_TOPRIGHT, upgradeFrames[side].frames[frameIndex - 4].cover.handle, side == SIDE_FRAME_LEFT and FRAMEPOINT_BOTTOMLEFT or FRAMEPOINT_BOTTOMRIGHT, 0, -0.003)
        else
            upgradeFrame.cover:setRelativePoint(side == SIDE_FRAME_LEFT and FRAMEPOINT_LEFT or FRAMEPOINT_RIGHT, upgradeFrames[side].frames[frameIndex - 1].cover.handle, side == SIDE_FRAME_LEFT and FRAMEPOINT_RIGHT or FRAMEPOINT_LEFT, side == SIDE_FRAME_LEFT and 0.001 or -0.001, 0)
        end
    else
        upgradeFrame:setVisible(true)
    end
    upgradeFrames[side].visible_total = frameIndex
end

function ShowStatisticsFrame(header, battles, onFinishCallback)
    totalUnitStatisticsBackdropFrame.cover:setAlpha(255):setVisible(true)
    totalUnitStatisticsHeaderFrame:setAlpha(255):setVisible(true):setText("РЕЗУЛЬТАТЫ - " .. header)
    PlayInterfaceSound(SOUND_INTERFACE_ALL_UNIT_BATTLES_COMPLETED)
    local frameSpaceWidth = GetScreenFrameWidth() - TOTAL_UNIT_STATISTICS_BACKDROP_PADDING_X * 2 - TOTAL_UNIT_STATISTICS_WRAPPER_PADDING_X * 2
    local frameSpaceHeight = TOTAL_UNIT_STATISTICS_BACKDROP_HEIGHT - TOTAL_UNIT_STATISTICS_WRAPPER_PADDING_Y * 2
    local iconFramesPerRow = math.floor((frameSpaceWidth + TOTAL_UNIT_STATISTICS_ICON_SPACE_X_MIN) / (TOTAL_UNIT_STATISTICS_ICON_FRAME_WIDTH + TOTAL_UNIT_STATISTICS_ICON_SPACE_X_MIN))
    local iconFramesPerCol = math.floor((frameSpaceHeight + TOTAL_UNIT_STATISTICS_ICON_SPACE_Y_MIN) / (TOTAL_UNIT_STATISTICS_ICON_FRAME_HEIGHT + TOTAL_UNIT_STATISTICS_ICON_SPACE_Y_MIN))
    local totalIconsWidth = iconFramesPerRow * TOTAL_UNIT_STATISTICS_ICON_FRAME_WIDTH
    local totalIconsHeight = iconFramesPerCol * TOTAL_UNIT_STATISTICS_ICON_FRAME_HEIGHT
    local finalIconFrameHorizontalSpaceBetween = (frameSpaceWidth - totalIconsWidth) / (iconFramesPerRow - 1)
    local finalIconFrameVerticalSpaceBetween = (frameSpaceHeight - totalIconsHeight) / (iconFramesPerCol - 1)
    for i, battle in ipairs(battles) do
        DelayCallback(TOTAL_UNIT_STATISTICS_APPEAR_DELAY * i, function()
            local wrapperFrame
            local iconFrame
            local textFrame
            if totalUnitStatisticsBattleListFrames[i] == nil then
                wrapperFrame = SimpleEmptyFrame:new("TotalUnitStatisticsEntryWrapper", totalUnitStatisticsBackdropFrame.cover.handle, i)
                iconFrame = TextureFrame:new("TotalUnitStatisticsEntryIcon", "", wrapperFrame.handle, i)
                textFrame = SimpleTextFrame:new("TotalUnitStatisticsEntryText", "", 2.25 * (TOTAL_UNIT_STATISTICS_ICON_FRAME_HEIGHT / 0.06), wrapperFrame.handle, i)
                wrapperFrame
                    :setSize(TOTAL_UNIT_STATISTICS_ICON_FRAME_WIDTH, TOTAL_UNIT_STATISTICS_ICON_FRAME_HEIGHT)
                iconFrame.cover
                    :setSize(TOTAL_UNIT_STATISTICS_ICON_FRAME_HEIGHT, TOTAL_UNIT_STATISTICS_ICON_FRAME_HEIGHT)
                    :setRelativePoint(FRAMEPOINT_TOPLEFT, wrapperFrame.handle, FRAMEPOINT_TOPLEFT, 0, 0)
                    :setRelativePoint(FRAMEPOINT_BOTTOMLEFT, wrapperFrame.handle, FRAMEPOINT_BOTTOMLEFT, 0, 0)
                textFrame
                    :setRelativePoint(FRAMEPOINT_TOPLEFT, iconFrame.cover.handle, FRAMEPOINT_TOPRIGHT, 0.003, 0)
                    :setRelativePoint(FRAMEPOINT_BOTTOMLEFT, iconFrame.cover.handle, FRAMEPOINT_BOTTOMLEFT, 0.003, 0)
                    :setRelativePoint(FRAMEPOINT_TOPRIGHT, wrapperFrame.handle, FRAMEPOINT_TOPRIGHT, 0, 0)
                    :setRelativePoint(FRAMEPOINT_BOTTOMRIGHT, wrapperFrame.handle, FRAMEPOINT_BOTTOMRIGHT, 0, 0)
                    :setAlignment(TEXT_JUSTIFY_MIDDLE, TEXT_JUSTIFY_CENTER)
                totalUnitStatisticsBattleListFrames[i] = {
                    wrapper = wrapperFrame,
                    icon = iconFrame,
                    text = textFrame
                }
            else
                wrapperFrame = totalUnitStatisticsBattleListFrames[i].wrapper
                iconFrame = totalUnitStatisticsBattleListFrames[i].icon
                textFrame = totalUnitStatisticsBattleListFrames[i].text
            end
            iconFrame:setTexture(battle.enemy.icon)
            textFrame
                :setText(battle.enemy.name .. "\n" .. (battle.is_winner and "Победа" or "Поражение") .. " (" .. battle.units_left .. ")")
                :setColor(battle.is_winner and 0 or 255, battle.is_winner and 255 or 0, 0)
            if i == 1 then
                wrapperFrame:setRelativePoint(FRAMEPOINT_TOPLEFT, totalUnitStatisticsWrapperFrame.handle, FRAMEPOINT_TOPLEFT, 0, 0)
            elseif (i - 1) % iconFramesPerRow == 0 then
                if math.floor((i - 1) / iconFramesPerRow) > (iconFramesPerCol - 1) then
                    for j = i - (iconFramesPerRow * iconFramesPerCol), i - (iconFramesPerRow * iconFramesPerCol) + iconFramesPerRow - 1 do
                        --debugPrintAny(i)
                        --debugPrintAny(iconFramesPerRow)
                        --debugPrintAny(iconFramesPerCol)
                        --debugPrintAny((i - 1) / iconFramesPerRow)
                        --debugPrintAny(j)
                        totalUnitStatisticsBattleListFrames[j].wrapper:setVisible(false):resetPoints()
                    end
                    totalUnitStatisticsBattleListFrames[i - (iconFramesPerRow * iconFramesPerCol) + iconFramesPerRow].wrapper:setRelativePoint(FRAMEPOINT_TOPLEFT, totalUnitStatisticsWrapperFrame.handle, FRAMEPOINT_TOPLEFT, 0, 0)
                end
                wrapperFrame:setRelativePoint(FRAMEPOINT_TOPLEFT, totalUnitStatisticsBattleListFrames[i - iconFramesPerRow].wrapper.handle, FRAMEPOINT_BOTTOMLEFT, 0, -finalIconFrameVerticalSpaceBetween)
            else
                wrapperFrame:setRelativePoint(FRAMEPOINT_TOPLEFT, totalUnitStatisticsBattleListFrames[i - 1].wrapper.handle, FRAMEPOINT_TOPRIGHT, finalIconFrameHorizontalSpaceBetween, 0)
            end
            DelayCallback(TOTAL_UNIT_STATISTICS_FADING_IN_DURATION / 2, function()
                PlayInterfaceSound(SOUND_INTERFACE_BATTLE_CONTAINER_APPEAR, 90)
            end)
            wrapperFrame:animateFadeIn(TOTAL_UNIT_STATISTICS_FADING_IN_DURATION, function()
                if i >= #battles then
                    onFinishCallback()
                end
            end)
        end)
    end
end

function HideStatisticsFrame(onFinishCallback)
    totalUnitStatisticsBackdropFrame.cover:animateFadeOut(0.5, function()
        for _, iconFrame in ipairs(totalUnitStatisticsBattleListFrames) do
            iconFrame.wrapper:setVisible(false):resetPoints()
        end
        onFinishCallback()
    end)
    totalUnitStatisticsHeaderFrame.cover:animateFadeOut(0.5)
end

function ShowFinalRacesFrame(raceSummary, onFinishCallback)
    totalBattlesStatisticsBackdropFrame.cover:setAlpha(255):setVisible(true)
    local frameSpaceWidth = GetScreenFrameWidth() - TOTAL_BATTLES_STATISTICS_BACKDROP_PADDING_X * 2 - TOTAL_BATTLES_STATISTICS_WRAPPER_PADDING_X * 2
    local frameSpaceHeight = 0.6 - TOTAL_BATTLES_STATISTICS_BACKDROP_PADDING_Y * 2 - TOTAL_BATTLES_STATISTICS_BACKDROP_PADDING_Y * 2
    local iconFramesPerRow = math.floor((frameSpaceWidth + TOTAL_BATTLES_STATISTICS_ICON_SPACE_X_MIN) / (TOTAL_BATTLES_STATISTICS_ICON_FRAME_WIDTH + TOTAL_BATTLES_STATISTICS_ICON_SPACE_X_MIN))
    local totalIconsWidth = iconFramesPerRow * TOTAL_BATTLES_STATISTICS_ICON_FRAME_WIDTH
    local finalIconFrameHorizontalSpaceBetween = (frameSpaceWidth - totalIconsWidth) / (iconFramesPerRow - 1)
    for i, race in ipairs(raceSummary) do
        local raceWrapperFrameHeight = TOTAL_BATTLES_STATISTICS_RACE_TEXT_HEIGHT
        local raceWrapperFrame
        local raceTextFrame
        local raceIcons
        if totalBattlesStatisticsBattleListFrames[i] == nil then
            raceWrapperFrame = SimpleEmptyFrame:new("TotalBattlesStatisticsRaceWrapper", totalBattlesStatisticsRacesWrapperFrame.handle, i)
            raceTextFrame = SimpleTextFrame:new("TotalBattlesStatisticsRaceText", "", TOTAL_BATTLES_STATISTICS_RACE_TEXT_SCALE, raceWrapperFrame.handle, i)
            raceTextFrame:setRelativePoint(FRAMEPOINT_TOPLEFT, raceWrapperFrame.handle, FRAMEPOINT_TOPLEFT, 0, 0)
            raceIcons = {}
            totalBattlesStatisticsBattleListFrames[i] = {
                wrapper = raceWrapperFrame,
                text = raceTextFrame,
                icons = raceIcons,
            }
        else
            raceWrapperFrame = totalBattlesStatisticsBattleListFrames[i].wrapper
            raceTextFrame = totalBattlesStatisticsBattleListFrames[i].text
            raceIcons = totalBattlesStatisticsBattleListFrames[i].icons
        end
        raceWrapperFrame:setVisible(false)
        raceTextFrame:setText("|cffffcc00" .. race.race .. "|r")
        if i == 1 then
            raceWrapperFrame
                :setRelativePoint(FRAMEPOINT_TOPLEFT, totalBattlesStatisticsRacesWrapperFrame.handle, FRAMEPOINT_TOPLEFT, 0, 0)
                :setRelativePoint(FRAMEPOINT_TOPRIGHT, totalBattlesStatisticsRacesWrapperFrame.handle, FRAMEPOINT_TOPRIGHT, 0, 0)
        else
            raceWrapperFrame
                :setRelativePoint(FRAMEPOINT_TOPLEFT, totalBattlesStatisticsBattleListFrames[i - 1].wrapper.handle, FRAMEPOINT_BOTTOMLEFT, 0, -TOTAL_BATTLES_STATISTICS_RACE_WRAPPER_SPACE_Y)
                :setRelativePoint(FRAMEPOINT_TOPRIGHT, totalBattlesStatisticsBattleListFrames[i - 1].wrapper.handle, FRAMEPOINT_BOTTOMRIGHT, 0, -TOTAL_BATTLES_STATISTICS_RACE_WRAPPER_SPACE_Y)
        end
        for j, unit in ipairs(race.units) do
            local wrapperFrame
            local iconFrame
            local textFrame
            if raceIcons[j] == nil then
                wrapperFrame = SimpleEmptyFrame:new("TotalBattlesStatisticsEntryWrapper", raceWrapperFrame.handle, j)
                iconFrame = TextureFrame:new("TotalBattlesStatisticsEntryIcon", "", wrapperFrame.handle, j)
                textFrame = SimpleTextFrame:new("TotalBattlesStatisticsEntryText", "", TOTAL_BATTLES_STATISTICS_ICON_TEXT_BASE_SCALE * (TOTAL_BATTLES_STATISTICS_ICON_FRAME_HEIGHT / 0.06), wrapperFrame.handle, j)
                wrapperFrame
                    :setSize(TOTAL_BATTLES_STATISTICS_ICON_FRAME_WIDTH, TOTAL_BATTLES_STATISTICS_ICON_FRAME_HEIGHT)
                iconFrame.cover
                    :setSize(TOTAL_BATTLES_STATISTICS_ICON_FRAME_HEIGHT, TOTAL_BATTLES_STATISTICS_ICON_FRAME_HEIGHT)
                    :setRelativePoint(FRAMEPOINT_TOPLEFT, wrapperFrame.handle, FRAMEPOINT_TOPLEFT, 0, 0)
                    :setRelativePoint(FRAMEPOINT_BOTTOMLEFT, wrapperFrame.handle, FRAMEPOINT_BOTTOMLEFT, 0, 0)
                textFrame
                    :setRelativePoint(FRAMEPOINT_TOPLEFT, iconFrame.cover.handle, FRAMEPOINT_TOPRIGHT, 0.002, 0)
                    :setRelativePoint(FRAMEPOINT_BOTTOMLEFT, iconFrame.cover.handle, FRAMEPOINT_BOTTOMLEFT, 0.002, 0)
                    :setRelativePoint(FRAMEPOINT_TOPRIGHT, wrapperFrame.handle, FRAMEPOINT_TOPRIGHT, 0, 0)
                    :setRelativePoint(FRAMEPOINT_BOTTOMRIGHT, wrapperFrame.handle, FRAMEPOINT_BOTTOMRIGHT, 0, 0)
                    :setAlignment(TEXT_JUSTIFY_MIDDLE, TEXT_JUSTIFY_CENTER)
                raceIcons[j] = {
                    wrapper = wrapperFrame,
                    icon = iconFrame,
                    text = textFrame
                }
            else
                wrapperFrame = raceIcons[j].wrapper
                iconFrame = raceIcons[j].icon
                textFrame = raceIcons[j].text
            end
            iconFrame:setTexture(unit.icon)
            local victoryPercentage = 0
            if unit.battles > 0 then
                victoryPercentage = unit.victories / unit.battles * 100
            end
            textFrame:setText(unit.name .. "\n" .. "Побед: " .. unit.victories .. "/" .. unit.battles .. " (" .. string.format("%.2f", victoryPercentage) .. "%)")
            if j == 1 then
                wrapperFrame:setRelativePoint(FRAMEPOINT_TOPLEFT, raceTextFrame.handle, FRAMEPOINT_BOTTOMLEFT, 0, -TOTAL_BATTLES_STATISTICS_RACE_TEXT_MARGIN_BOTTOM)
                raceWrapperFrameHeight = raceWrapperFrameHeight + TOTAL_BATTLES_STATISTICS_ICON_FRAME_HEIGHT + TOTAL_BATTLES_STATISTICS_RACE_TEXT_MARGIN_BOTTOM
            elseif (j - 1) % iconFramesPerRow == 0 then
                wrapperFrame:setRelativePoint(FRAMEPOINT_TOPLEFT, raceIcons[j - iconFramesPerRow].wrapper.handle, FRAMEPOINT_BOTTOMLEFT, 0, -TOTAL_UNIT_STATISTICS_ICON_SPACE_Y_MIN)
                raceWrapperFrameHeight = raceWrapperFrameHeight + TOTAL_BATTLES_STATISTICS_ICON_FRAME_HEIGHT + TOTAL_UNIT_STATISTICS_ICON_SPACE_Y_MIN
            else
                wrapperFrame:setRelativePoint(FRAMEPOINT_TOPLEFT, raceIcons[j - 1].wrapper.handle, FRAMEPOINT_TOPRIGHT, finalIconFrameHorizontalSpaceBetween, 0)
            end
        end
        raceWrapperFrame:setSize(0, raceWrapperFrameHeight)
        totalBattlesStatisticsBattleListFrames[i].height = raceWrapperFrameHeight
    end
    PlayInterfaceSound(SOUND_INTERFACE_ALL_BATTLES_COMPLETED)
    totalBattlesStatisticsRacesWrapperFrame:animateFadeIn(1.5)
    DelayCallback(0.9, function()
        local bufferHeight = 0
        local firstRaceFramesIndex = 1
        for i, raceFrames in ipairs(totalBattlesStatisticsBattleListFrames) do
            DelayCallback((i - 1) * 3, function()
                bufferHeight = bufferHeight + raceFrames.height
                if bufferHeight > frameSpaceHeight then
                    repeat
                        local needlessRaceFrames = totalBattlesStatisticsBattleListFrames[firstRaceFramesIndex]
                        needlessRaceFrames.wrapper:setVisible(false):resetPoints()
                        bufferHeight = bufferHeight - needlessRaceFrames.height - TOTAL_BATTLES_STATISTICS_RACE_WRAPPER_SPACE_Y
                        firstRaceFramesIndex = firstRaceFramesIndex + 1
                        totalBattlesStatisticsBattleListFrames[firstRaceFramesIndex].wrapper
                            :setRelativePoint(FRAMEPOINT_TOPLEFT, totalBattlesStatisticsRacesWrapperFrame.handle, FRAMEPOINT_TOPLEFT, 0, 0)
                            :setRelativePoint(FRAMEPOINT_TOPRIGHT, totalBattlesStatisticsRacesWrapperFrame.handle, FRAMEPOINT_TOPRIGHT, 0, 0)
                    until bufferHeight <= frameSpaceHeight
                end
                raceFrames.wrapper:animateFadeIn(1, function()
                    if i == #totalBattlesStatisticsBattleListFrames then
                        onFinishCallback()
                    end
                end)
            end)
        end
    end)
end

function ShowFinalTopsFrame(notHeroes, heroes)
    local units = {notHeroes, heroes}
    totalBattlesStatisticsBackdropFrame.cover:setAlpha(255):setVisible(true)
    for i, container in ipairs(totalBattlesStatisticsTopsContainers) do
        for j, subcontainer in ipairs(container.subContainers) do
            for k, unitListContainer in ipairs(subcontainer.subContainers) do
                local unit = units[i][j][k]
                if unit then
                    unitListContainer.wrapper:setVisible(true)
                    unitListContainer.icon:setTexture(unit.icon)
                    local victoryPercentage = 0
                    if unit.battles > 0 then
                        victoryPercentage = unit.victories / unit.battles * 100
                    end
                    unitListContainer.text:setText(unit.name .. "\n" .. "Побед: " .. unit.victories .. "/" .. unit.battles .. " (" .. string.format("%.2f", victoryPercentage) .. "%)")
                else
                    unitListContainer.wrapper:setVisible(false)
                end
            end
        end
    end
    PlayInterfaceSound(SOUND_INTERFACE_UNITS_TOPS_APPEAR)
    totalBattlesStatisticsTopsWrapperFrame:animateFadeIn(1.5)
end